{% extends "base.html" %}

{% block title %}Dashboard - Cybersecurity Drift Detection{% endblock %}

{% block content %}
<div class="row">
    <!-- System Overview Cards -->
    <div class="col-12 mb-4">
        <div class="row">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Features Monitored</h6>
                                <h3 class="mb-0" id="featuresCount">{{ feature_names|length }}</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-eye fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Active Alerts</h6>
                                <h3 class="mb-0" id="activeAlerts">0</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-exclamation-triangle fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Model Accuracy</h6>
                                <h3 class="mb-0" id="modelAccuracy">--</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-bullseye fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">System Status</h6>
                                <h6 class="mb-0" id="systemStatusCard">{{ system_status }}</h6>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-server fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Control Panel -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cogs me-2"></i>Control Panel
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Drift Simulation</h6>
                        <div class="btn-group d-flex" role="group">
                            <button type="button" class="btn btn-outline-primary" onclick="simulateDrift('gradual')">
                                <i class="fas fa-chart-line me-1"></i>Gradual Drift
                            </button>
                            <button type="button" class="btn btn-outline-warning" onclick="simulateDrift('sudden')">
                                <i class="fas fa-bolt me-1"></i>Sudden Drift
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="simulateDrift('ddos')">
                                <i class="fas fa-shield-alt me-1"></i>DDoS Attack
                            </button>
                            <button type="button" class="btn btn-outline-info" onclick="simulateDrift('exfiltration')">
                                <i class="fas fa-download me-1"></i>Data Exfiltration
                            </button>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h6>System Actions</h6>
                        <div class="btn-group d-flex" role="group">
                            <button type="button" class="btn btn-success" onclick="initializeSystem()">
                                <i class="fas fa-power-off me-1"></i>Initialize
                            </button>
                            <button type="button" class="btn btn-info" onclick="retrainModel()">
                                <i class="fas fa-sync-alt me-1"></i>Retrain Model
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="refreshDashboard()">
                                <i class="fas fa-refresh me-1"></i>Refresh
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard Content -->
    <div class="col-lg-8">
        <!-- Drift Timeline Chart -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>Drift Detection Timeline
                </h5>
            </div>
            <div class="card-body">
                <div id="driftTimelineChart" style="height: 400px;"></div>
            </div>
        </div>

        <!-- Feature Status Grid -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-th me-2"></i>Feature Status Overview
                </h5>
            </div>
            <div class="card-body">
                <div id="featureStatusGrid" style="height: 400px;"></div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Recent Alerts -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bell me-2"></i>Recent Alerts
                </h5>
            </div>
            <div class="card-body">
                <div id="recentAlerts">
                    <p class="text-muted text-center">No alerts to display</p>
                </div>
            </div>
        </div>

        <!-- Feature Monitoring -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>Feature Monitoring
                </h5>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush" id="featureList">
                    {% for feature in feature_names %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span>{{ feature.replace('_', ' ').title() }}</span>
                        <span class="badge bg-success rounded-pill" id="status-{{ feature }}">OK</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- System Metrics -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>System Metrics
                </h5>
            </div>
            <div class="card-body">
                <div id="systemMetrics">
                    <div class="mb-3">
                        <small class="text-muted">Last Update</small>
                        <div id="lastUpdate">--</div>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">Processing Time</small>
                        <div id="processingTime">--</div>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">Data Points Analyzed</small>
                        <div id="dataPoints">--</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Alert Details Modal -->
<div class="modal fade" id="alertModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Alert Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="alertModalBody">
                <!-- Alert details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="acknowledgeAlert()">Acknowledge</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Dashboard-specific JavaScript
let dashboardData = {};
let alertCount = 0;

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
    setInterval(loadDashboardData, 30000); // Refresh every 30 seconds
});

// Load dashboard data
async function loadDashboardData() {
    try {
        const response = await fetch('/api/visualizations/dashboard');
        if (response.ok) {
            dashboardData = await response.json();
            updateDashboard();
        }
    } catch (error) {
        console.error('Error loading dashboard data:', error);
    }
}

// Update dashboard elements
function updateDashboard() {
    // Update alerts
    updateAlerts();
    
    // Update charts
    updateDriftTimeline();
    updateFeatureStatus();
    
    // Update metrics
    updateSystemMetrics();
}

// Update alerts display
function updateAlerts() {
    const alerts = dashboardData.alerts || [];
    alertCount = alerts.length;
    
    document.getElementById('alertCount').textContent = alertCount;
    document.getElementById('activeAlerts').textContent = alertCount;
    
    const alertsContainer = document.getElementById('recentAlerts');
    if (alerts.length === 0) {
        alertsContainer.innerHTML = '<p class="text-muted text-center">No alerts to display</p>';
        return;
    }
    
    alertsContainer.innerHTML = alerts.slice(0, 5).map(alert => `
        <div class="alert alert-${getSeverityClass(alert.severity)} alert-sm mb-2">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <strong>${alert.feature}</strong>
                    <br><small>${alert.message}</small>
                </div>
                <small class="text-muted">${formatTime(alert.timestamp)}</small>
            </div>
        </div>
    `).join('');
}

// Update drift timeline chart
function updateDriftTimeline() {
    const timelineData = dashboardData.drift_timeline || [];
    
    if (timelineData.length === 0) {
        Plotly.newPlot('driftTimelineChart', [], {
            title: 'No drift data available',
            height: 400
        });
        return;
    }
    
    const trace = {
        x: timelineData.map(d => d.timestamp),
        y: timelineData.map(d => d.features_affected),
        type: 'scatter',
        mode: 'lines+markers',
        name: 'Features Affected',
        line: {color: '#007bff', width: 3},
        marker: {size: 8}
    };
    
    const layout = {
        title: 'Drift Detection Timeline',
        xaxis: {title: 'Time'},
        yaxis: {title: 'Features Affected'},
        height: 400,
        margin: {t: 40, r: 40, b: 40, l: 60}
    };
    
    Plotly.newPlot('driftTimelineChart', [trace], layout);
}

// Update feature status
function updateFeatureStatus() {
    const featureStatus = dashboardData.feature_status || {};
    
    Object.keys(featureStatus).forEach(feature => {
        const status = featureStatus[feature];
        const badge = document.getElementById(`status-${feature}`);
        
        if (badge) {
            badge.className = `badge rounded-pill bg-${getSeverityClass(status.severity)}`;
            badge.textContent = status.severity;
        }
    });
}

// Update system metrics
function updateSystemMetrics() {
    document.getElementById('lastUpdate').textContent = formatTime(new Date().toISOString());
    document.getElementById('processingTime').textContent = '< 1s';
    document.getElementById('dataPoints').textContent = '1,000+';
}

// Simulate drift
async function simulateDrift(driftType) {
    showLoading();
    
    try {
        const response = await fetch('/api/drift/simulate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({drift_type: driftType})
        });
        
        if (response.ok) {
            const result = await response.json();
            showAlert('success', `${driftType.charAt(0).toUpperCase() + driftType.slice(1)} drift simulation completed`);
            loadDashboardData(); // Refresh dashboard
        } else {
            showAlert('error', 'Failed to simulate drift');
        }
    } catch (error) {
        showAlert('error', 'Error simulating drift: ' + error.message);
    } finally {
        hideLoading();
    }
}

// Initialize system
async function initializeSystem() {
    showLoading();
    
    try {
        const response = await fetch('/api/system/initialize', {method: 'POST'});
        if (response.ok) {
            const result = await response.json();
            showAlert('success', 'System initialized successfully');
            loadDashboardData();
        } else {
            showAlert('error', 'Failed to initialize system');
        }
    } catch (error) {
        showAlert('error', 'Error initializing system: ' + error.message);
    } finally {
        hideLoading();
    }
}

// Retrain model
async function retrainModel() {
    showLoading();
    
    try {
        const response = await fetch('/api/model/retrain', {method: 'POST'});
        if (response.ok) {
            const result = await response.json();
            showAlert('success', 'Model retrained successfully');
            loadDashboardData();
        } else {
            showAlert('error', 'Failed to retrain model');
        }
    } catch (error) {
        showAlert('error', 'Error retraining model: ' + error.message);
    } finally {
        hideLoading();
    }
}

// Refresh dashboard
function refreshDashboard() {
    loadDashboardData();
    showAlert('info', 'Dashboard refreshed');
}

// Helper functions
function getSeverityClass(severity) {
    const severityMap = {
        'LOW': 'success',
        'MEDIUM': 'warning', 
        'HIGH': 'danger'
    };
    return severityMap[severity] || 'secondary';
}

function formatTime(timestamp) {
    return new Date(timestamp).toLocaleTimeString();
}

function showAlert(type, message) {
    // Create and show bootstrap alert
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.row'));
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}
</script>
{% endblock %}